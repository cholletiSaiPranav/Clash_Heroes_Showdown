<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clash_Heroes_Showdown_Play v2.0 (CHSP)</title>
  <style>
    :root{--bg:#0f1226;--card:#171a37;--text:#eaf0ff;--muted:#aab8ff;--accent:#7cf2c8;--accent2:#ffd166;--danger:#ff6b6b}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#0f1226 0%,#1a1f4b 100%);color:var(--text)}
    .wrap{max-width:1160px;margin:0 auto;padding:24px}
    .title{font-size:28px;font-weight:800;letter-spacing:.6px;margin:6px 0 18px}
    .subtitle{color:var(--muted);margin:0 0 18px}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-6{grid-template-columns:repeat(6,minmax(0,1fr))}
    .card{background:linear-gradient(180deg, rgba(203, 14, 14, 0.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);backdrop-filter: blur(4px);border-radius:16px;padding:16px;box-shadow:0 14px 40px rgba(0,0,0,.28)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{height:10px}
    .btn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:12px 16px;border-radius:12px;color:var(--text);cursor:pointer;font-weight:700;letter-spacing:.4px;transition:.15s transform ease,.2s background;text-align:center}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.1)}
    .btn.primary{background:linear-gradient(90deg,var(--accent) 0%,#8ef9d9 100%);color:#0d192b;border:none}
    .btn.warn{background:linear-gradient(90deg,var(--accent2) 0%,#ffe599 100%);color:#1b1300;border:none}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .menu{display:none}
    .menu.active{display:block}
    .hl{color:var(--accent)}
    .muted{color:var(--muted)}
    .char-card{display:flex;flex-direction:column;gap:10px;border-radius:14px;border:1px dashed rgba(255,255,255,.14);padding:12px;cursor:pointer;transition:.15s transform ease,.2s box-shadow}
    .char-card:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .char-swatch{height:86px;border-radius:12px;border:2px solid rgba(255,255,255,.25)}
    .char-name{font-weight:800}
    .char-desc{color:#c7d2ff;font-size:13px}
    .char-card.selected{outline:3px solid var(--accent)}
    .six-pane{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;align-items:start}
    .divider{display:flex;align-items:center;justify-content:center}
    .play-pod{position:sticky;top:16px;display:flex;flex-direction:column;gap:12px}
    .stage-wrap{display:none}
    .stage-wrap.active{display:block}
    #gameCanvas{background:#87ceeb;display:block;margin:auto;border-radius:16px;border:2px solid rgba(255,255,255,.15)}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    td,th{padding:10px 12px}
    th{text-align:left;color:#bcd0ff;font-size:13px}
    tbody tr{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.2);color:var(--text)}
    label{font-size:13px;color:#c9d4ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="title">üéÆ Clash_Heroes_Showdown_Play <span class="pill">v2.0</span></div>
      <div class="row">
        <button class="btn ghost" id="backBtn" title="Go Back">‚üµ Back</button>
        <button class="btn ghost" id="homeBtn" title="Home">üè† Home</button>
      </div>
    </div>

    <!-- HOME -->
    <section id="screen-home" class="menu active">
      <p class="subtitle">A Multiplayer-Game created by : <span class="hl">CHSP</span>.<br> Supports up to 6 players online!<br>Flow: Try Game ‚Üí Main Menu ‚Üí Start Game ‚Üí Modes ‚Üí VS Mode ‚Üí Character Select ‚Üí Play<br>(!STILL UNDER DEVELOPMENT!)<br>contact me: <span class="hl">cholletisaipranav@gmail.com</span></p>
      <div class="grid cols-2">
        <div class="card">
          <div class="title">Home</div>
          <div class="grid cols-2">
            <button class="btn primary" data-nav="main">‚ñ∂ Try Game</button>
            <button class="btn" data-nav="keys">‚å® Key Settings</button>
            <button class="btn" disabled>üîê Login (stub)</button>
            <button class="btn" disabled>üìù Register (stub)</button>
          </div>
        </div>
        <div class="card">
          <div class="title">Details</div>
          <ul class="subtitle">
            <li>You can change your key settings from Key Settings.</li>
            <li>Don't try to find bugs, as it may affect your user experience.</li>
            <li>Currently a game of 6 characters, up to 6 players.</li>
            <li><strong>ENJOY CLASHING</strong></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- MAIN MENU -->
    <section id="screen-main" class="menu">
      <div class="grid cols-3">
        <div class="card">
          <div class="title">Main Menu</div>
          <div class="grid">
            <button class="btn primary" data-nav="modes">‚ñ∂ Start Game</button>
            <button class="btn" data-nav="characters">üë§ Character List</button>
            <button class="btn" data-nav="keys">‚å® Key Settings</button>
            <button class="btn" data-nav="guide">üìò Guide</button>
            <button class="btn" data-nav="network">üåê Network Game</button>
          </div>
        </div>
        <div class="card">
          <div class="title">Tip</div>
          <p>Use <span class="pill">Back</span> or <span class="pill">Home</span> anytime.</p>
        </div>
      </div>
    </section>

    <!-- NETWORK -->
    <section id="screen-network" class="menu">
      <div class="title">Network Game (Up to 6 Players)</div>
      <div class="grid cols-2">
        <div class="card">
          <div class="title">Create Room</div>
          <button class="btn primary" id="createRoomBtn">Create</button>
          <p id="roomIdDisplay"></p>
        </div>
        <div class="card">
          <div class="title">Join Room</div>
          <input id="roomIdInput" placeholder="Enter Room ID">
          <button class="btn primary" id="joinRoomBtn">Join</button>
        </div>
      </div>
    </section>

    <!-- MODES -->
    <section id="screen-modes" class="menu">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">Select Mode</div>
          <div class="grid cols-2">
            <button class="btn primary" data-nav="vs-select">‚öî VS Mode (Multiplayer)</button>
            <button class="btn" disabled>üå™ Survival (todo)</button>
          </div>
        </div>
        <div class="card">
          <div class="title">About VS</div>
          <p>Pick characters and duel with up to 6 players on floating platforms.</p>
        </div>
      </div>
    </section>

    <!-- VS SELECT -->
    <section id="screen-vs-select" class="menu">
      <div class="title">VS Mode ‚Äî Character Select (Up to 6 Players)</div>
      <div class="six-pane" id="playerPanes"></div>
      <div class="play-pod" style="text-align:center; margin-top:20px;">
        <button class="btn primary" id="playBtn" disabled>‚ñ∂ Start Game</button>
        <button class="btn" data-nav="modes">‚üµ Back to Modes</button>
      </div>
    </section>

    <!-- CHARACTER LIST -->
    <section id="screen-characters" class="menu">
      <div class="title">Character List</div>
      <div id="charList" class="grid cols-4"></div>
    </section>

    <!-- KEY SETTINGS -->
    <section id="screen-keys" class="menu">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">Key Settings (For Your Local Controls)</div>
          <form id="keysForm" class="grid cols-2">
            <div>
              <h4>Your Controls</h4>
              <label>Left <input name="left" value="a" maxlength="1"></label>
              <label>Right <input name="right" value="d" maxlength="1"></label>
              <label>Jump <input name="jump" value="w" maxlength="1"></label>
              <label>Down <input name="down" value="x" maxlength="1"></label>
              <label>Attack <input name="attack" value="s" maxlength="1"></label>
              <label>Defence <input name="defence" value="f" maxlength="1"></label>
              <label>Special <input name="special" value="g" maxlength="1"></label>
            </div>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn primary" type="submit">üíæ Save</button>
              <button class="btn" id="resetKeys" type="button">‚Ü∫ Reset</button>
            </div>
          </form>
        </div>
        <div class="card">
          <div class="title">Notes</div>
          <p>Single key per move (case-insensitive). Keys are saved locally. In multiplayer, each player uses their own controls.</p>
        </div>
      </div>
    </section>

    <!-- GUIDE -->
    <section id="screen-guide" class="menu">
      <div class="title">Guide</div>
      <div class="card">
        <ul>
          <li><strong style="color:#e67e22;">Swordsman</strong> üó°Ô∏è (HP: 120, Color: <span style="color:#e67e22;">#e67e22</span>)<br>Basic Attack: A powerful melee slash that deals <strong>25 damage</strong>.<br>Special Ability: Temporarily gains <strong>2√ó movement speed</strong> for <strong>3 seconds</strong>.</li>
          <li><strong style="color:#2ecc71;">Archer</strong> üèπ (HP: 100, Color: <span style="color:#2ecc71;">#2ecc71</span>)<br>Basic Attack: Fires arrows dealing <strong>10 damage</strong> per shot.<br>Special Ability: Fires a <strong>fast arrow</strong> that deals <strong>20 damage</strong>.</li>
          <li><strong style="color:#3498db;">Icezzy</strong> ‚ùÑÔ∏è (HP: 105, Color: <span style="color:#3498db;">#3498db</span>)<br>Basic Attack: Shoots an ice bolt that deals <strong>10 damage</strong>.<br>Special Ability: Freeze attack that does <strong>10 damage</strong> and <strong>slows enemy for 10 seconds</strong>.</li>
          <li><strong style="color:#2ecc40;">Poisonerer</strong> ‚ò†Ô∏è (HP: 95, Color: <span style="color:#2ecc40;">#2ecc40</span>)<br>Basic Attack: Shoots a dart that deals <strong>10 immediate damage</strong>.<br>Special Ability: Deals <strong>10 direct + 10 over 15 seconds</strong>.</li>
          <li><strong style="color:#9b59b6;">Healer</strong> ‚ú® (HP: 100, Color: <span style="color:#9b59b6;">#9b59b6</span>)<br>Basic Attack: Fires a bolt dealing <strong>10 damage</strong>.<br>Special Ability: Heals for <strong>40 HP over 20 seconds</strong> (90s cooldown).</li>
          <li><strong style="color:#1abc9c;">NightGhost</strong> üåô (HP: 80, Color: <span style="color:#1abc9c;">#1abc9c</span>)<br>Basic Attack: Fires bullets that deal <strong>10 damage</strong> (6 ammo, 8 in Domain).<br>Passive: Phase (intangible) at night for 30 seconds (50s cooldown).</li>
        </ul>
      </div>
    </section>

    <!-- GAME STAGE -->
    <section id="screen-stage" class="stage-wrap">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="pill" id="hudPlayers"></div>
        <div class="row" style="gap:6px">
          <button class="btn" id="restartBtn">‚Üª Restart</button>
          <button class="btn warn" data-nav="vs-select">‚üµ Exit to Select</button>
        </div>
      </div>
      <canvas id="gameCanvas" width="1500" height="540"></canvas>
    </section>

  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    /********************
     * Router + State   *
     ********************/
    const screens = {
      home: document.getElementById('screen-home'),
      main: document.getElementById('screen-main'),
      modes: document.getElementById('screen-modes'),
      vsSelect: document.getElementById('screen-vs-select'),
      characters: document.getElementById('screen-characters'),
      keys: document.getElementById('screen-keys'),
      guide: document.getElementById('screen-guide'),
      stage: document.getElementById('screen-stage'),
      network: document.getElementById('screen-network'),
    };
    const historyStack = [];
    function show(name){
      for(const k in screens){ screens[k].classList.remove('active'); }
      if(name==='stage'){ screens.stage.classList.add('active'); }
      else { screens[name].classList.add('active'); }
      if(name!=='home') historyStack.push(name);
      updateBackBtn();
      if(name==='vsSelect'){ renderSelectPanes(); updateSelections(); 
        document.getElementById('playBtn').style.display = isOnline && playerNum !== 1 ? 'none' : 'block'; 
      }
    }
    function updateBackBtn(){ document.getElementById('backBtn').disabled = historyStack.length===0; }
    document.getElementById('homeBtn').onclick = ()=>{ historyStack.length=0; show('home'); };
    document.getElementById('backBtn').onclick = ()=>{ historyStack.pop(); const prev = historyStack.pop(); show(prev || 'home'); };
    document.querySelectorAll('[data-nav]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const target = btn.getAttribute('data-nav');
        const map={main:'main',keys:'keys',characters:'characters',guide:'guide',modes:'modes','vs-select':'vsSelect', network:'network'};
        show(map[target]||'home');
      });
    });

    /********************
     * Network Setup    *
     ********************/
    const socket = io(); // Relative URL for flexibility
    let isOnline = false;
    let playerNum = 0;
    let localPlayer, players = [];
    const holdActions = ['left', 'right', 'jump', 'down', 'defence'];
    const triggerActions = ['attack', 'special'];
    const MAX_PLAYERS = 6;

    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomIdDisplay = document.getElementById('roomIdDisplay');
    const roomIdInput = document.getElementById('roomIdInput');

    createRoomBtn.onclick = () => {
      socket.emit('createRoom', (roomId) => {
        roomIdDisplay.textContent = `Room ID: ${roomId}. Waiting for players (up to 6)...`;
        isOnline = true;
        playerNum = 1;
        show('vsSelect');
      });
    };

    joinRoomBtn.onclick = () => {
      const roomId = roomIdInput.value.trim();
      if (!roomId) return alert('Enter a room ID');
      socket.emit('joinRoom', roomId, (success, assignedNum) => {
        if (success) {
          isOnline = true;
          playerNum = assignedNum;
          show('vsSelect');
        } else {
          alert('Failed to join room. It may be full or invalid.');
        }
      });
    };

    socket.on('playerJoined', (data) => {
      // Update player count or UI if needed
    });

    socket.on('playerChose', (data) => {
      selected[data.player] = data.charId;
      updateSelections();
    });

    socket.on('gameStart', (data) => {
      selected = data.choices;
      startOnlineMatch(data.playerNum, data.choices);
    });

    socket.on('remoteInput', (data) => {
      const p = players.find(pl => pl.playerId === data.playerId);
      if (p) {
        if (data.type === 'hold') {
          p.actions[data.action] = data.value;
        } else if (data.type === 'trigger') {
          if (data.action === 'attack') p.attack(false);
          if (data.action === 'special') p.useSpecial(players.filter(pl => pl !== p)); // Special may affect all
        }
      }
    });

    socket.on('playerDisconnected', (disconnectedPlayerId) => {
      alert(`Player ${disconnectedPlayerId} disconnected.`);
      // Remove player from game
      players = players.filter(p => p.playerId !== disconnectedPlayerId);
      if (players.length < 2) {
        cleanupMatch();
        show('network');
      }
    });

    /********************
     * Characters       *
     ********************/
    const CHARACTERS = [
      { id:'Swordsman', name:'Swordsman', color:'#e67e22', hp:120, desc:'Melee slash 25 dmg. Special: 2√ó speed (3s).', role:'Swordsman' },
      { id:'Archer', name:'Archer', color:'#2ecc71', hp:100, desc:'Arrow 10 dmg. Special: fast arrow 20 dmg.', role:'Archer' },
      { id:'Icezzy', name:'Icezzy', color:'#3498db', hp:105, desc:'Ice bolt 10 dmg. Special: freeze 10 dmg + slow.', role:'Icezzy' },
      { id:'Poisoner', name:'Poisonerer', color:'#2ecc40', hp:95, desc:'Dart 10 dmg. Special: 10 direct + 10 over 15s.', role:'Poisoner' },
      { id:'Healer', name:'Healer', color:'#9b59b6', hp:100, desc:'Bolt 10 dmg. Special: heal 40/20s (90s cd).', role:'Healer' },
      { id:'NightGhost', name:'NightGhost', color:'#1abc9c', hp:80, desc:'Bullets 10 dmg. Ammo 6 (8 in Domain). Passive phasing at night.', role:'NightGhost' },
    ];

    const charListEl = document.getElementById('charList');
    function renderCharList(targetEl){ if(!targetEl) return; targetEl.innerHTML=''; CHARACTERS.forEach(ch=>{ const card=document.createElement('div'); card.className='char-card'; card.innerHTML=`<div class="char-swatch" style="background:${ch.color}"></div><div class="char-name">${ch.name}</div><div class="char-desc">${ch.desc}</div>`; targetEl.appendChild(card); }); }
    renderCharList(charListEl);

    const playerPanesEl = document.getElementById('playerPanes');
    const playBtn = document.getElementById('playBtn');
    let selected = Array(MAX_PLAYERS + 1).fill(null); // Index 1 to 6
    function renderSelectPanes(){ 
      playerPanesEl.innerHTML = '';
      for (let i = 1; i <= MAX_PLAYERS; i++) {
        const pane = document.createElement('div');
        pane.className = 'card';
        pane.id = `p${i}Pane`;
        pane.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="subtitle">Player ${i}</div>
            <span class="pill" id="p${i}ChoiceLabel">None</span>
          </div>
          <div class="grid cols-2" id="p${i}CharGrid"></div>
        `;
        playerPanesEl.appendChild(pane);
        renderSelectGrid(document.getElementById(`p${i}CharGrid`), i);
      }
    }
    function renderSelectGrid(gridEl, playerId){ 
      gridEl.innerHTML=''; 
      CHARACTERS.forEach(ch=>{ 
        const card=document.createElement('div'); 
        card.className='char-card'; 
        card.dataset.id=ch.id; 
        card.innerHTML=`<div class="char-swatch" style="background:${ch.color}"></div><div class="char-name">${ch.name}</div><div class="char-desc">${ch.desc}</div>`; 
        const canSelect = !isOnline || playerId === playerNum;
        if (canSelect) {
          card.onclick=()=>{ 
            selected[playerId]=ch.id; 
            updateSelections(); 
            if (isOnline) socket.emit('choose', {player: playerNum, charId: ch.id}); 
          }; 
        }
        gridEl.appendChild(card); 
      }); 
    }
    function updateSelections(){ 
      let allSelected = true;
      for (let i = 1; i <= MAX_PLAYERS; i++) {
        const grid = document.getElementById(`p${i}CharGrid`);
        if (grid) [...grid.children].forEach(el => el.classList.toggle('selected', el.dataset.id === selected[i]));
        const label = document.getElementById(`p${i}ChoiceLabel`);
        if (label) {
          label.textContent = selected[i] ? CHARACTERS.find(c => c.id === selected[i]).name : (isOnline && i !== playerNum ? 'Waiting...' : 'None');
          if (!selected[i]) allSelected = false;
        }
      }
      if (playBtn) playBtn.disabled = !allSelected;
    }

    /********************
     * Key Settings     *
     ********************/
    const DEFAULT_KEYS = {left:'a',right:'d',jump:'w',down:'x',attack:'s',defence:'f',special:'g'};
    function loadKeys(){ const saved = JSON.parse(localStorage.getItem('Clash_Heroes_Showdown_Play_keys')||'null'); return saved || JSON.parse(JSON.stringify(DEFAULT_KEYS)); }
    function saveKeys(keys){ localStorage.setItem('Clash_Heroes_Showdown_Play_keys', JSON.stringify(keys)); }

    const keysForm = document.getElementById('keysForm');
    const resetBtn = document.getElementById('resetKeys');
    function fillForm(){ if(!keysForm) return; const k=loadKeys(); keysForm.left.value=k.left; keysForm.right.value=k.right; keysForm.jump.value=k.jump; keysForm.down.value=k.down; keysForm.attack.value=k.attack; keysForm.defence.value=k.defence; keysForm.special.value=k.special; }
    if(keysForm){ fillForm(); keysForm.addEventListener('submit',(e)=>{ e.preventDefault(); const fd=new FormData(keysForm); const cfg={}; cfg.left=(fd.get('left')||'a').toLowerCase(); cfg.right=(fd.get('right')||'d').toLowerCase(); cfg.jump=(fd.get('jump')||'w').toLowerCase(); cfg.down=(fd.get('down')||'x').toLowerCase(); cfg.attack=(fd.get('attack')||'s').toLowerCase(); cfg.defence=(fd.get('defence')||'f').toLowerCase(); cfg.special=(fd.get('special')||'g').toLowerCase(); saveKeys(cfg); alert('Keys saved!'); }); resetBtn && resetBtn.addEventListener('click',()=>{ saveKeys(DEFAULT_KEYS); fillForm(); alert('Reset to defaults.'); }); }

    /********************
     * Game Engine      *
     ********************/
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gravity = 0.6;
    const GOLD = 'rgba(255,215,0,0.95)';
    const platforms = [ {x:150,y:390,w:140,h:12}, {x:710,y:390,w:140,h:12}, {x:340,y:250,w:140,h:12}, {x:560,y:250,w:140,h:12}, {x:1000,y:390,w:140,h:12}, {x:1200,y:250,w:140,h:12} ]; // Added more platforms

    const slashes = []; const sparks=[];
    let nightUntil = 0;
    const isNight = () => Date.now() < nightUntil;

    class Player {
      constructor(x, base, controls, playerId) {
        this.playerId = playerId;
        this.x = x; this.y = 430; this.width = 40; this.height = 50; this.color = base.color;
        this.velY = 0; this.isJumping = false; this.health = base.hp; this.maxHealth = base.hp;
        this.controls = controls; this.role = base.role; this.arrows = []; this.direction = 1; this.isDefending = false; this.ignorePlatform = false;
        this.slowEndTime = 0; this.PoisonerEndTime = 0; this.PoisonerInterval = null; this.speedBoostEnd = 0; this.specialCooldownEnd = 0;
        this.attackCooldownEnd = 0;
        this.baseSpeed = 5;
        this.domainActiveEnd = 0;
        this.ammo = (this.role === 'Swordsman') ? null : (this.role === 'NightGhost' ? 6 : 7);
        this.reloadEnd = 0;
        this.healAuraEnd = 0; this.healInterval = null; this.auraPulse = 0;
        this.healCooldownEnd = 0;
        this._frameStartX = this.x; this._frameStartY = this.y; this._stationary = false;
        this._activeIntervals = [];
        this.actions = {left: false, right: false, jump: false, down: false, defence: false};
        this.attackFlag = false;
        this.specialFlag = false;
      }
      // ... (keep all other methods like facing, currentSpeed, getAmmoCap, isReloading, isStationary, opponentWithin2Heights, draw, moveLeft, moveRight, jump, down, attack, useSpecial, update, applyFreeze, applyPoisonerOverTime, drawArrows, cleanupTimers, remaining the same)
      // Note: In useSpecial, for NightGhost, opponentWithin2Heights can check against any opponent
      opponentWithin2Heights(opponents) {
        return opponents.some(opp => Math.abs((this.x + this.width / 2) - (opp.x + opp.width / 2)) <= (2 * this.height));
      }
      useSpecial(opponents) {
        const now = Date.now();
        if (this.role === 'NightGhost') {
          if (now < this.specialCooldownEnd) return;
          if (!this.opponentWithin2Heights(opponents)) return;
          // ... rest same
        }
        // ... other roles same
      }
    }

    function drawPlatforms(){ ctx.fillStyle='rgba(240,240,255,.85)'; platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h)); }

    function drawHealthBars(players) {
      const barWidth = 120; const barHeight = 12; const y = 30; const offsetX = 20;
      ctx.font = '12px Arial';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#000';

      function getHealthColor(ratio) {
        if (ratio > 0.6) return '#2ecc71';
        if (ratio > 0.3) return '#e67e22';
        return '#e74c3c';
      }

      players.forEach((p, index) => {
        const text = `P${p.playerId} ${Math.max(0, Math.floor(p.health))} HP`;
        ctx.fillText(text, offsetX, y + index * 20);
        const textWidth = ctx.measureText(text).width;
        let barX = offsetX + textWidth + 8;
        let barY = y + index * 20 - barHeight / 2;

        ctx.fillStyle = '#222';
        roundRect(ctx, barX, barY, barWidth, barHeight, 4, true, true);

        const ratio = p.health / p.maxHealth;
        ctx.fillStyle = getHealthColor(ratio);
        roundRect(ctx, barX, barY, barWidth * ratio, barHeight, 4, true, false);
      });
    }

    function drawBackground(){
      const night = isNight();
      const grd=ctx.createLinearGradient(0,0,0,canvas.height);
      if(night){ grd.addColorStop(0,'#0b0f2a'); grd.addColorStop(1,'#1a2044'); }
      else{ grd.addColorStop(0,'#a7d8ff'); grd.addColorStop(1,'#c7f0ff'); }
      ctx.fillStyle=grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      if(night){ ctx.fillStyle='rgba(255,255,255,0.6)'; for(let i=0;i<60;i++){ const x=(i*97)%canvas.width; const y=(i*53)%200 + 20; ctx.fillRect(x,y,2,2); } }
    }

    function hitSpark(x,y){ sparks.push({x,y,ttl:250}); }
    function drawSparks(){ for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.ttl-=16; if(s.ttl<=0){sparks.splice(i,1);continue;} ctx.strokeStyle='rgba(255,255,255,.7)'; ctx.beginPath(); ctx.moveTo(s.x-6,s.y); ctx.lineTo(s.x+6,s.y); ctx.moveTo(s.x,s.y-6); ctx.lineTo(s.x,s.y+6); ctx.stroke(); } }

    function checkCollisions(players){
      // Generalized for multiple players
      players.forEach(owner => {
        // Owner's arrows vs others' arrows
        for (let i = owner.arrows.length - 1; i >= 0; i--) {
          const a1 = owner.arrows[i];
          players.forEach(target => {
            if (target === owner) return;
            for (let j = target.arrows.length - 1; j >= 0; j--) {
              const a2 = target.arrows[j];
              if (a1.x < a2.x + a2.width && a1.x + a1.width > a2.x && a1.y < a2.y + a2.height && a1.y + a1.height > a2.y) {
                if (a1.super && !a2.super) { target.arrows.splice(j, 1); continue; }
                if (!a1.super && a2.super) { owner.arrows.splice(i, 1); break; }
                if (a1.super && a2.super) continue;
                target.arrows.splice(j, 1);
                owner.arrows.splice(i, 1);
                break;
              }
            }
          });
        }

        // Slashes
        for (let k = slashes.length - 1; k >= 0; k--) {
          const s = slashes[k]; const now = Date.now();
          if (s.owner !== owner) continue;
          if (now < s.activateAt) { ctx.setLineDash([6, 4]); ctx.strokeStyle = 'rgba(255,215,0,.5)'; ctx.lineWidth = 2; ctx.strokeRect(s.x, s.y, s.w, s.h); ctx.setLineDash([]); continue; }
          if (now > s.endAt) { slashes.splice(k, 1); continue; }
          ctx.strokeStyle = GOLD; ctx.lineWidth = 4; ctx.strokeRect(s.x, s.y, s.w, s.h);
          players.forEach(target => {
            if (target === owner) return;
            for (let ai = target.arrows.length - 1; ai >= 0; ai--) {
              const a = target.arrows[ai];
              if (a.x < s.x + s.w && a.x + a.width > s.x && a.y < s.y + s.h && a.y + a.height > s.y) {
                hitSpark(a.x, a.y); target.arrows.splice(ai, 1);
              }
            }
            if (s.x < target.x + target.width && s.x + s.w > target.x && s.y < target.y + target.height && s.y + s.h > target.y) {
              const dmg = s.super ? s.damage : (target.isDefending ? 10 : s.damage);
              target.health -= dmg; hitSpark(target.x + target.width / 2, target.y + target.height / 2);
              slashes.splice(k, 1);
              break;
            }
          });
        }

        // Projectiles hitting players
        for (let ai = owner.arrows.length - 1; ai >= 0; ai--) {
          const a = owner.arrows[ai];
          players.forEach(target => {
            if (target === owner) return;
            if (a.x < target.x + target.width && a.x + a.width > target.x && a.y < target.y + target.height && a.y + a.height > target.y) {
              if (target.role === 'NightGhost' && target.isStationary() && isNight()) {
                return;
              } else {
                const defendingFront = target.isDefending && ((target.direction === 1 && a.speed < 0) || (target.direction === -1 && a.speed > 0));
                const dmg = a.super ? a.damage : (defendingFront ? 1 : a.damage);
                target.health -= dmg;
                if (a.freeze) target.applyFreeze();
                if (a.PoisonerSpecial) target.applyPoisonerOverTime(10, 15000);
                hitSpark(target.x + target.width / 2, target.y + target.height / 2);
                owner.arrows.splice(ai, 1);
              }
            }
          });
        }
      });
    }

    // Input
    const keysDown = {};
    function initKeyListeners() {
      window.addEventListener('keydown', e => {
        const key = e.key.toLowerCase();
        if (isOnline) {
          const action = Object.keys(localPlayer.controls).find(a => localPlayer.controls[a] === key);
          if (action) {
            if (holdActions.includes(action)) {
              localPlayer.actions[action] = true;
              socket.emit('input', {type: 'hold', action, value: true, playerId: playerNum});
            } else if (triggerActions.includes(action)) {
              const flag = action + 'Flag';
              if (!localPlayer[flag]) {
                if (action === 'attack') localPlayer.attack(false);
                else localPlayer.useSpecial(players.filter(p => p !== localPlayer));
                socket.emit('input', {type: 'trigger', action, playerId: playerNum});
                localPlayer[flag] = true;
              }
            }
          }
        } else {
          keysDown[key] = true;
        }
      });
      window.addEventListener('keyup', e => {
        const key = e.key.toLowerCase();
        if (isOnline) {
          const action = Object.keys(localPlayer.controls).find(a => localPlayer.controls[a] === key);
          if (action) {
            if (holdActions.includes(action)) {
              localPlayer.actions[action] = false;
              socket.emit('input', {type: 'hold', action, value: false, playerId: playerNum});
            } else if (triggerActions.includes(action)) {
              const flag = action + 'Flag';
              localPlayer[flag] = false;
            }
          }
        } else {
          keysDown[key] = false;
        }
      });
    }
    initKeyListeners();

    // HUD
    const hudPlayers = document.getElementById('hudPlayers');

    // Start match
    let animId = null;
    function cleanupMatch(){ cancelAnimationFrame(animId); slashes.length = 0; sparks.length = 0; players.forEach(p => p.cleanupTimers()); players = []; }
    function startMatch(choices) {
      isOnline = false;
      cleanupMatch();
      const k = loadKeys();
      const startingPositions = [120, 300, 500, 700, 900, 1100]; // Spread out
      players = [];
      for (let i = 1; i <= MAX_PLAYERS; i++) {
        if (choices[i]) {
          const c = CHARACTERS.find(c => c.id === choices[i]) || CHARACTERS[0];
          players.push(new Player(startingPositions[i - 1], c, k, i));
        }
      }
      hudPlayers.textContent = `Players: ${players.length}`;
      nightUntil = 0;
      show('stage'); gameLoop();
    }

    function startOnlineMatch(pNum, choices) {
      playerNum = pNum;
      isOnline = true;
      cleanupMatch();
      const k = loadKeys();
      const dummyControls = {left:'', right:'', jump:'', down:'', attack:'', defence:'', special:''};
      const startingPositions = [120, 300, 500, 700, 900, 1100];
      players = [];
      for (let i = 1; i <= MAX_PLAYERS; i++) {
        if (choices[i]) {
          const c = CHARACTERS.find(c => c.id === choices[i]);
          const controls = (i === playerNum) ? k : dummyControls;
          const p = new Player(startingPositions[i - 1], c, controls, i);
          players.push(p);
          if (i === playerNum) localPlayer = p;
        }
      }
      hudPlayers.textContent = `Players: ${players.length}`;
      nightUntil = 0;
      show('stage');
      gameLoop();
    }

    function handlePlayerControls(p, opponents) {
      p.isDefending = p.actions.defence;
      if (p.actions.left) p.moveLeft();
      if (p.actions.right) p.moveRight();
      if (p.actions.jump) p.jump();
      if (p.actions.down) p.down();
    }

    function drawPowerHUD(p){
      // ... same as before, but for each player
    }

    function gameLoop(timestamp) {
      ctx.clearRect(0, 0, canvas.width, canvas.height); drawBackground(); drawPlatforms();
      players.forEach(p => {
        p._frameStartX = p.x; p._frameStartY = p.y;
      });

      if (!isOnline) {
        // Local mode inputs (for testing, but online is focus)
        players.forEach(p => {
          p.actions.left = keysDown[p.controls.left];
          p.actions.right = keysDown[p.controls.right];
          p.actions.jump = keysDown[p.controls.jump];
          p.actions.down = keysDown[p.controls.down];
          p.actions.defence = keysDown[p.controls.defence];
          if (keysDown[p.controls.attack]) {
            if (!keysDown[`_atk_p${p.playerId}`]) {
              p.attack(false);
              keysDown[`_atk_p${p.playerId}`] = true;
            }
          } else keysDown[`_atk_p${p.playerId}`] = false;
          if (keysDown[p.controls.special]) {
            if (!keysDown[`_sp_p${p.playerId}`]) {
              p.useSpecial(players.filter(pl => pl !== p));
              keysDown[`_sp_p${p.playerId}`] = true;
            }
          } else keysDown[`_sp_p${p.playerId}`] = false;
        });
      }

      players.forEach(p => {
        handlePlayerControls(p, players.filter(pl => pl !== p));
        p.update();
      });

      checkCollisions(players);

      players.forEach(p => {
        p.draw(); p.drawArrows(); drawPowerHUD(p);
      });

      drawHealthBars(players); drawSparks();

      // Win state: last one standing
      const alivePlayers = players.filter(p => p.health > 0);
      if (alivePlayers.length <= 1) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        const winner = alivePlayers[0] ? `PLAYER ${alivePlayers[0].playerId} WINS!` : 'DRAW!';
        ctx.fillStyle = '#f1c40f';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(winner, canvas.width / 2, canvas.height / 2);
        ctx.fillStyle = '#fff';
        ctx.fillText('Press R to Restart or M for Menu', canvas.width / 2, canvas.height / 2 + 40);
        return;
      }
      animId = requestAnimationFrame(gameLoop);
    }

    // Buttons
    const playBtnEl = document.getElementById('playBtn');
    const restartBtn = document.getElementById('restartBtn');
    if (playBtnEl) playBtnEl.onclick = () => {
      if (selected.filter(s => s).length < 2) { alert('At least 2 players must select characters.'); return; }
      if (isOnline) socket.emit('startGame');
      else startMatch(selected);
    };
    if (restartBtn) restartBtn.onclick = () => {
      if (isOnline) socket.emit('startGame');
      else startMatch(selected);
    };

    // Handle keydown for restart/menu in game over
    window.addEventListener('keydown', (e) => {
      if (players.filter(p => p.health > 0).length <= 1) {
        if (e.key.toLowerCase() === 'r') {
          if (isOnline) socket.emit('startGame');
          else startMatch(selected);
        }
        if (e.key.toLowerCase() === 'm') {
          cleanupMatch();
          show('vsSelect');
        }
      }
    });

    // Initial route
    show('home');
  </script>
</body>
</html>